Aqui est√° a **User Story 03** detalhada, formatada como um prompt t√©cnico. Esta hist√≥ria foca na camada de seguran√ßa (Infrastructure Layer) e na integra√ß√£o com o Identity Provider (Keycloak).

---

# User Story: Implementa√ß√£o de Seguran√ßa OAuth2/JWT com Keycloak

**T√≠tulo:** Prote√ß√£o da API de Ingest√£o via OAuth2 Resource Server (US-03)
**Contexto:** Atualmente, o endpoint de carga `/api/v1/integracao/agendamentos` est√° p√∫blico. Precisamos restringir o acesso para que apenas sistemas autorizados (Sistema Legado) com um Token JWT v√°lido e o perfil espec√≠fico possam enviar dados.

## üìù Descri√ß√£o da Hist√≥ria
**Como** Arquiteto de Seguran√ßa,
**Quero** configurar o `ms-ingestao` para atuar como um *OAuth2 Resource Server*,
**Para que** ele valide automaticamente os tokens JWT emitidos pelo Keycloak, rejeitando requisi√ß√µes an√¥nimas ou com permiss√µes insuficientes, sem precisar gerenciar usu√°rios localmente.

---

## ‚öôÔ∏è Especifica√ß√µes T√©cnicas (Constraints)

1.  **Padr√£o de Seguran√ßa:**
    *   Utilizar **Spring Security 6+** (Stateless).
    *   Protocolo: **OIDC / OAuth2**.
    *   O servi√ßo n√£o deve ter tela de login, apenas validar o Header `Authorization: Bearer <token>`.
2.  **Role-Based Access Control (RBAC):**
    *   O endpoint de carga deve exigir a role: `ROLE_INTEGRADOR`.
    *   O Spring Security deve ser capaz de ler as roles de dentro do claim `realm_access.roles` do Token JWT do Keycloak (que n√£o vem no formato padr√£o do Spring).
3.  **Endpoints P√∫blicos:**
    *   Manter `/actuator/**` e `/swagger-ui/**` (se houver) acess√≠veis sem autentica√ß√£o para fins de monitoramento e documenta√ß√£o local.
4.  **Configura√ß√£o Externalizada:**
    *   A URL do Keycloak deve ficar no `application.yml` para facilitar a troca entre ambiente Docker e Local.

---

## ‚úÖ Crit√©rios de Aceite (Acceptance Criteria)

### 1. Depend√™ncias de Seguran√ßa
*   O `pom.xml` deve incluir `spring-boot-starter-oauth2-resource-server` e `spring-boot-starter-security`.

### 2. Conversor de Claims (Keycloak Converter)
*   Criar uma classe `KeycloakJwtConverter` que implemente `Converter<Jwt, AbstractAuthenticationToken>`.
*   Ela deve extrair a lista de roles do JSON `realm_access` -> `roles`.
*   Deve prefixar as roles com `ROLE_` (ex: `integrador` vira `ROLE_INTEGRADOR`) e mapear para `SimpleGrantedAuthority`.

### 3. Cadeia de Filtros de Seguran√ßa (SecurityFilterChain)
*   Configurar o `SecurityConfig` para:
    *   Desabilitar CSRF (API Stateless).
    *   Definir sess√£o como `STATELESS`.
    *   Proteger `/api/v1/integracao/**` exigindo autentica√ß√£o.
    *   Liberar endpoints t√©cnicos (Swagger/Actuator).

### 4. Autoriza√ß√£o no N√≠vel do M√©todo
*   Habilitar `@EnableMethodSecurity`.
*   Anotar o `AgendamentoController` (criado na US-01) com `@PreAuthorize("hasRole('INTEGRADOR')")`.

### 5. Comportamento HTTP Esperado
*   Requisi√ß√£o sem Header Authorization -> **401 Unauthorized**.
*   Requisi√ß√£o com Token v√°lido mas sem a role `integrador` -> **403 Forbidden**.
*   Requisi√ß√£o com Token v√°lido e role `integrador` -> **202 Accepted**.

---

## üíª Solicita√ß√£o de C√≥digo

Com base nas especifica√ß√µes acima, gere:

1.  **Atualiza√ß√£o do pom.xml**: Adicione as depend√™ncias de seguran√ßa.
2.  **KeycloakJwtConverter.java**: A classe para extrair as roles do formato espec√≠fico do Keycloak.
3.  **SecurityConfig.java**: A classe de configura√ß√£o principal do Spring Security.
4.  **Atualiza√ß√£o do Controller**: Adicione a anota√ß√£o de autoriza√ß√£o no endpoint de POST.
5.  **Atualiza√ß√£o do application.yml**: Configure as propriedades `spring.security.oauth2.resourceserver.jwt` apontando para o Keycloak (considere a URL `http://localhost:8081/realms/sus-hackathon`).
6.  **Instru√ß√µes para Docker Compose**: Adicione o servi√ßo do Keycloak ao `docker-compose.yml` (imagem `quay.io/keycloak/keycloak:23.0.0`) com as vari√°veis de ambiente b√°sicas (`KEYCLOAK_ADMIN`, `KC_DB=dev-file` ou postgres) para subir em modo de desenvolvimento.