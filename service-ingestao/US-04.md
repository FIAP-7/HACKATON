# User Story: Implementa√ß√£o do Webhook de Retorno do WhatsApp (Twilio)

**T√≠tulo:** Adapter de Recebimento de Respostas do Twilio (US-05)
**Contexto:** O sistema envia mensagens para os pacientes (simulado), e eles respondem via WhatsApp ("1", "SIM", "CANCELAR"). O provedor (Twilio) envia essas respostas via HTTP POST para nossa API. Precisamos capturar, higienizar e enfileirar essas respostas.

## üìù Descri√ß√£o da Hist√≥ria
**Como** Plataforma de Mensageria Externa (Twilio),
**Quero** enviar um POST para o endpoint de webhook do `ms-ingestao` contendo a resposta do usu√°rio,
**Para que** o sistema processe a decis√£o do paciente (Confirma√ß√£o ou Cancelamento) de forma ass√≠ncrona.

---

## ‚öôÔ∏è Especifica√ß√µes T√©cnicas (Constraints)

1.  **Contrato do Twilio:**
    *   O Twilio **n√£o** envia JSON. Ele envia `application/x-www-form-urlencoded`.
    *   O Controller deve consumir `MediaType.APPLICATION_FORM_URLENCODED_VALUE`.
    *   Campos relevantes do payload:
        *   `From`: Ex: `whatsapp:+5511999998888` (Vem com prefixo).
        *   `Body`: Ex: `Sim`, `1`, `Quero` (Texto digitado pelo usu√°rio).
2.  **Tratamento de Dados:**
    *   **Higieniza√ß√£o:** Remover o prefixo `whatsapp:` do telefone antes de enviar para a fila.
    *   **Normaliza√ß√£o:** O sistema deve armazenar apenas `5511999998888`.
3.  **Fluxo Ass√≠ncrono:**
    *   O endpoint deve responder **HTTP 200 OK** (ou XML vazio TwiML) imediatamente para o Twilio n√£o reter a mensagem na fila de retry dele.
    *   A l√≥gica de neg√≥cio (decidir se √© confirma√ß√£o ou repescagem) **n√£o** ocorre aqui. Apenas publicamos o evento.

---

## ‚úÖ Crit√©rios de Aceite (Acceptance Criteria)

### 1. Novo Endpoint de Webhook
*   **M√©todo:** `POST`
*   **URI:** `/api/v1/webhook/twilio`
*   **Consumes:** `application/x-www-form-urlencoded`
*   **Par√¢metros:** Deve aceitar um `Map<String, String>` ou `@RequestParam` para capturar `From` e `Body`.

### 2. DTO de Evento Interno
*   Criar o Record `EventoRespostaUsuario` (pacote `core`) contendo:
    *   `telefone`: String (Limpo, sem prefixo).
    *   `resposta`: String (Conte√∫do da mensagem).
    *   `dataRecebimento`: LocalDateTime.

### 3. Publica√ß√£o no RabbitMQ
*   Atualizar a configura√ß√£o do RabbitMQ (`RabbitMqConfig`) para garantir que a fila `sus.input.resposta-usuario` e a routing key `rota.resposta.usuario` existam.
*   O Service deve publicar o `EventoRespostaUsuario` nesta rota.

### 4. Resposta HTTP
*   Retornar status **200 OK**. O corpo pode ser vazio ou um TwiML simples `<Response></Response>` (opcional, 200 vazio funciona na maioria dos casos, mas XML evita warnings no log do Twilio).

---

## üíª Solicita√ß√£o de C√≥digo

Com base nas especifica√ß√µes acima, gere:

1.  **Atualiza√ß√£o do RabbitMqConfig.java**: Adicione a defini√ß√£o da Queue `sus.input.resposta-usuario` e o Binding com a routing key `rota.resposta.usuario`.
2.  **EventoRespostaUsuario.java**: O Record no pacote `core/domain` ou `entrypoint/dto`.
3.  **RespostaPublisherPort.java**: Interface no pacote `core` para envio deste tipo espec√≠fico de evento.
4.  **RabbitMqRespostaProducer.java**: Implementa√ß√£o no pacote `infra` (pode ser a mesma classe do producer anterior se refatorada, ou uma nova classe dedicada).
5.  **WebhookController.java**: O Controller que recebe o POST form-urlencoded, limpa o telefone (remove "whatsapp:") e chama o servi√ßo.
6.  **IngestaoService.java**: Atualize o servi√ßo para incluir o m√©todo `processarRespostaUsuario`.