# User Story: Inicializa√ß√£o do Microsservi√ßo e API de Ingest√£o de Agendamentos

**T√≠tulo:** Setup do Projeto `ms-ingestao` e Implementa√ß√£o do Endpoint de Carga (Clean Architecture)
**Contexto:** Estamos iniciando o desenvolvimento do "Middleware de Otimiza√ß√£o do SUS". Este √© o microsservi√ßo de porta de entrada (Gatekeeper).

## üìù Descri√ß√£o da Hist√≥ria
**Como** Sistema Legado do SUS (Integrador),
**Quero** enviar uma requisi√ß√£o HTTP POST com os dados brutos dos agendamentos m√©dicos,
**Para que** o sistema receba, valide a integridade dos dados imediatamente e inicie o fluxo de otimiza√ß√£o de forma ass√≠ncrona.

---

## ‚öôÔ∏è Especifica√ß√µes T√©cnicas (Constraints)

1.  **Stack Tecnol√≥gica:**
    *   Java 21 (LTS).
    *   Spring Boot 3.2.x.
    *   Gerenciador de Depend√™ncias: Maven.
2.  **Arquitetura:**
    *   Seguir princ√≠pios de **Clean Architecture** (ou Hexagonal simplificada para microsservi√ßos).
    *   Separar claramente a camada de **Entrada** (Controllers/DTOs) da camada de **Aplica√ß√£o** (Services/Interfaces).
    *   **Importante:** Este microsservi√ßo √© **Stateless**. N√£o configure conex√£o com banco de dados (JPA/Hibernate) nesta etapa.
3.  **Funcionalidades da Linguagem:**
    *   Utilizar **Java Records** para todos os DTOs (Data Transfer Objects).
    *   Habilitar **Virtual Threads** no `application.yml` (`spring.threads.virtual.enabled=true`).

---

## ‚úÖ Crit√©rios de Aceite (Acceptance Criteria)

### 1. Estrutura do Projeto (Scaffolding)
*   O projeto deve ser um m√≥dulo Maven chamado `ms-ingestao`.
*   O `pom.xml` deve incluir as depend√™ncias:
    *   `spring-boot-starter-web`
    *   `spring-boot-starter-validation` (Jakarta Bean Validation)
    *   `lombok` (Opcional, mas prefer√≠vel usar Records nativos)
*   A estrutura de pacotes deve seguir:
    *   `br.com.sus.ingestao.entrypoint.controller`
    *   `br.com.sus.ingestao.entrypoint.dto`
    *   `br.com.sus.ingestao.core.usecase` (Interface de servi√ßo)
    *   `br.com.sus.ingestao.core.domain` (Modelos de dom√≠nio, se necess√°rio)

### 2. Endpoint de Ingest√£o
*   **M√©todo:** `POST`
*   **URI:** `/api/v1/integracao/agendamentos`
*   **Comportamento:**
    *   Deve receber um JSON (estrutura abaixo).
    *   Deve validar os campos obrigat√≥rios e formatos.
    *   Se v√°lido: Delegar para uma classe Service (que por enquanto apenas logar√° "Recebido com sucesso") e retornar **HTTP 202 Accepted**.
    *   Se inv√°lido: Retornar **HTTP 400 Bad Request** com detalhamento dos erros.

### 3. Contrato de Dados (JSON Schema & Valida√ß√µes)
Mapear o JSON para Records com as seguintes anota√ß√µes de valida√ß√£o (`jakarta.validation.constraints`):

*   **Raiz (`AgendamentoRequest`):**
    *   `idExterno`: String, Obrigat√≥rio (`@NotBlank`).
    *   `paciente`: Objeto, Obrigat√≥rio (`@NotNull`, `@Valid`).
    *   `consulta`: Objeto, Obrigat√≥rio (`@NotNull`, `@Valid`).

*   **Objeto Paciente (`PacienteDto`):**
    *   `nome`: String, Obrigat√≥rio.
    *   `telefone`: String, Obrigat√≥rio, Padr√£o E.164 (`@Pattern(regexp = "^\\+?[1-9]\\d{1,14}$")`).

*   **Objeto Consulta (`ConsultaDto`):**
    *   `dataHora`: LocalDateTime, Obrigat√≥rio, Deve ser no futuro (`@Future`).
    *   `medico`: String, Obrigat√≥rio.
    *   `especialidade`: String, Obrigat√≥rio (pode ser String por enquanto).
    *   `unidadeId`: String, Obrigat√≥rio.

### 4. Tratamento de Erros (Global Exception Handler)
*   Implementar um `@RestControllerAdvice`.
*   Capturar `MethodArgumentNotValidException`.
*   Retornar um JSON padronizado de erro no status 400:
    ```json
    {
      "status": 400,
      "erro": "Dados inv√°lidos",
      "campos": [
        { "campo": "paciente.telefone", "mensagem": "Formato de telefone inv√°lido" },
        { "campo": "consulta.dataHora", "mensagem": "A data deve ser futura" }
      ]
    }
    ```

---

## üíª Solicita√ß√£o de C√≥digo

Com base nas especifica√ß√µes acima, gere:
1.  O arquivo `pom.xml` com as depend√™ncias.
2.  A classe `Application.java` principal.
3.  Os **Records** (DTOs) com as anota√ß√µes de valida√ß√£o.
4.  O **Controller** (`AgendamentoController`) e o **Service Interface/Impl** (`IngestaoService`).
5.  O **Handler de Exce√ß√µes** (`ApiExceptionHandler`).
6.  O arquivo `application.yml` habilitando Virtual Threads.